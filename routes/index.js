var express=require('express'),router=express.Router();const passport=require('passport');var fs=require('fs'),mysql=require('mysql'),config=require('../config/config'),bcrypt=require('bcrypt-nodejs'),multer=require('multer'),request=require('request'),url=require('url'),uploadDir=multer({dest:'public/images'}),nameOfFileField=uploadDir.single('imageToUpload'),nameOfFileField1=uploadDir.single('imageToUpload1'),nameOfFileField3=uploadDir.single('imageToUpload3'),connection=mysql.createConnection(config.db);connection.connect(function(a){if(a)throw a});const env={AUTH0_CLIENT_ID:config.auth0.clientId,AUTH0_DOMAIN:config.auth0.domain,AUTH0_CALLBACK_URL:'http://localhost:3000/callback'};router.all('/*',(a,b,c)=>{a.session.uid==void 0?(console.log('you are not loggedin'),c()):a.session.uid!=void 0&&(console.log('YOU ARE LOGGEDIN'),b.locals.firstNameTest=a.session.fname,b.locals.lastNameTest=a.session.lname,b.locals.emailTest=a.session.email,b.locals.profileimgTest=a.session.profileimg,b.locals.uidTest=a.session.uid,b.locals.phoneTest=a.session.phone,c())}),router.get('/',function(a,b){b.render('index',{})}),router.get('/register',function(a,b){b.render('register',{})}),router.post('/registerProcess',function(a,b){function f(){return new Promise((o,p)=>{var r=bcrypt.hashSync(k);connection.query('insert into users (first_name, last_name, email, password, zipcode, phone) values (?,?,?,?,?,?);',[g,h,j,r,n,m],s=>{s?p(s):o('insert successful')})})}var g=a.body.first_name,h=a.body.last_name,j=a.body.email,k=a.body.passwordOne,l=a.body.passwordTwo,m=a.body.phone;k!=l&&b.redirect('/register?msg=PasswordNotMatch');var n=a.body.zipCode;(function(){return new Promise((o,p)=>{connection.query('select * from users where email = ?;',[j],(r,s)=>{r?p(r):o(s)})})})().then(o=>{return 0==o.length?f():void b.redirect('/register?msg=alreadyRegistered')}).then(()=>{b.redirect('/login')}).catch(o=>{throw o})}),router.get('/login',function(a,b){b.render('login',{})}),router.post('/loginProcess',function(a,b){function f(j){return new Promise(k=>{var m=bcrypt.compareSync(h,j[0].password);m?(a.session.fname=j[0].first_name,a.session.lname=j[0].last_name,a.session.email=j[0].email,a.session.uid=j[0].id,a.session.location=j[0].zipcode,a.session.profileimg=j[0].profile_imgUrl,a.session.phone=j[0].phone,k(m)):k(m)})}var g=a.body.email,h=a.body.password;(function(){return new Promise((j,k)=>{connection.query('select * from users where email = ?;',[g],(m,n)=>{m?k(m):j(n)})})})().then(j=>{return 0==j.length?b.redirect('/login?msg=badpassword1'):f(j)}).then(j=>{return j?b.redirect('/listings'):j?void 0:b.redirect('/login?msg=badpassword2')})}),router.get('/registerWithAuth0',passport.authenticate('auth0',{clientID:env.AUTH0_CLIENT_ID,domain:env.AUTH0_DOMAIN,redirectUri:env.AUTH0_CALLBACK_URL,responseType:'code',audience:'https://'+env.AUTH0_DOMAIN+'/userinfo',scope:'openid '}),(a,b)=>{b.redirect('/')}),router.get('/callback',()=>{passport.authenticate('auth0',{failureRedirect:'/failure'}),function(d,f){f.redirect('/')}}),router.get('/failure',function(a,b){var c=a.flash('error'),d=a.flash('error_description');a.logout(),b.render('failure',{error:c[0],error_description:d[0]})}),router.get('/upload',function(a,b){b.render('upload',{})}),router.post('/uploadProcess',nameOfFileField,(a,b)=>{var d=a.body.breed_type_select,f=a.body.dog_breed_select,g=a.body.cat_breed_select,h=a.body.pet_name,j=a.body.age,k=a.body.gender,l=a.body.location,m=a.body.description,n=a.file.path,o=`public/images/listings/${a.file.originalname}`,q=function(){return new Promise(function(r,s){fs.readFile(n,(t,u)=>{if(t)throw t;fs.writeFile(o,u,v=>{if(v)throw v;var w=`UPDATE upload SET img_url = ? WHERE id = Last_INSERT_ID()`;connection.query(w,[a.file.originalname],()=>{console.log(a.file.path),v?s(v):r('image added')})})})})};(function(){return new Promise(function(r,s){var t=`INSERT INTO upload (user_id, type, cat_breed, dog_breed, name_upload, age, gender, description,location) VALUES (?,?,?, ?, ?, ?, ?,?,?)`;connection.query(t,[a.session.uid,d,f,g,h,j,k,m,l],u=>{u?s(u):r('info added')})})})().then(function(r){return console.log(r),q(r)}).then(function(){b.redirect('/uploadSuccess')})}),router.get('/uploadSuccess',(a,b)=>{b.render('uploadSuccess')}),router.get('/listings',(a,b)=>{var f=a.session.location;(function(){return new Promise((g,h)=>{connection.query('select species, name,age,animalID,animalLocation, breed, descriptionPlain, pictures from pets where status = \'available\' and animalLocation = ?;',[f],(k,l)=>{if(k)h(k);else{var m=Math.floor(Math.random()*l.length);g(l[m])}})})})().then(g=>{var h,j=JSON.parse(g.pictures),k;k=0==j.length?'No Photos':j[0].originalUrl,h=null==g.descriptionPlain?'No description at this point.':g.descriptionPlain,b.render('listings',{name:g.name,age:g.age,description:h,location:g.animalLocation,breed:g.breed,id:g.animalID,photo:k})}).catch(g=>{console.log(g)})}),router.get('/singles/:id',(a,b)=>{function f(h){return new Promise((j,k)=>{connection.query('select distinct orgs.email, orgs.name from orgs inner join pets on orgs.orgID = (select orgID from pets where animalID = ?);',[g],(m,n)=>{m?k(m):j({results:n,specific:h})})})}var g=a.params.id;console.log(g),function(){return new Promise((h,j)=>{connection.query('SELECT * from pets where animalID = ?;',[g],(l,m)=>{l?j(l):h(m)})})}().then(h=>{var j,k,m,l=JSON.parse(h[0].pictures);return console.log(h[0].animalID),k=0==l.length?'No Photos':l[0].originalUrl,j=null==h[0].descriptionPlain?'No description at this point.':h[0].descriptionPlain,void 0==m?f(h):void b.render('singlePage',{name:h[0].name,age:h[0].age,description:j,photo:k,breed:h[0].breed,sex:h[0].sex,contactInfo:h[0].contactEmail,id:g,contactName:h[0].contactName})}).then(h=>{var j,k,l=JSON.parse(h.specific[0].pictures);k=0==l.length?'No Photos':l[0].originalUrl,j=null==h.specific[0].descriptionPlain?'No description at this point.':h.specific[0].descriptionPlain,b.render('singlePage',{name:h.specific[0].name,age:h.specific[0].age,description:j,photo:k,breed:h.specific[0].breed,sex:h.specific[0].sex,id:g,contactInfo:h.results[0].email,contactName:h.results[0].name})}).catch(h=>{console.log(h)})}),router.post('/search',(a,b)=>{function f(s){return new Promise((t,u)=>{connection.query('DROP TABLE TemporaryTable;',v=>{v?u(v):t(s)})})}var g=a.body.typeSelect,h,j,k,l,m=a.body.location,n=a.body.ageSelect,o=a.body.genderSelect,p,q;'dog'==g?(h=a.body.dog_breed_select,j=`create table TemporaryTable (SELECT * FROM upload); ALTER TABLE TemporaryTable DROP COLUMN dog_breed;`,h==void 0?(k='SELECT * FROM TemporaryTable where age = ? and gender = ? and location =?;',l='select name, descriptionPlain, age, animalID, pictures, animalLocation, age, sex from pets where species = ? and animalLocation = ? and age =? and sex =?;',q=function(){return new Promise((s,t)=>{connection.query(k,[n,o,m],(u,v)=>{u?t(u):(console.log(v),s(v))})})},p=function(s){return new Promise((t,u)=>{connection.query(l,[g,m,n,o],(v,w)=>{v?u(v):t({results:w,dataFromUpload:s})})})}):(k='SELECT * FROM TemporaryTable where and cat_breed = ? and age = ? and gender = ? and location =?;',l='select name, descriptionPlain, age, animalID, pictures, animalLocation, breed, age, sex from pets where species = ? and animalLocation = ? and breed = ? and age =? and sex =?;',q=function(){return new Promise((s,t)=>{connection.query(k,[h,n,o,m],(u,v)=>{u?t(u):s(v)})})},p=function(s){return new Promise((t,u)=>{connection.query(l,[g,m,h,n,o],(v,w)=>{v?u(v):t({results:w,dataFromUpload:s})})})})):'cat'==g&&(h=a.body.cat_breed_select,j=`create table TemporaryTable (SELECT * FROM upload); ALTER TABLE TemporaryTable DROP COLUMN cat_breed;`,h==void 0?(k='SELECT * FROM TemporaryTable where user_id = ? and age = ? and gender = ?;',l='select name, descriptionPlain, age, animalID, pictures, animalLocation, age, sex from pets where species = ? and animalLocation = ? and age =? and sex =?;',q=function(){return new Promise((s,t)=>{connection.query(k,[a.session.uid,n,o],(u,v)=>{u?t(u):s(v)})})},p=function(s){return new Promise((t,u)=>{connection.query(l,[g,m,n,o],(v,w)=>{v?u(v):t({results:w,dataFromUpload:s})})})}):(k='SELECT * FROM TemporaryTable where user_id = ? and dog_breed = ? and age = ? and gender = ?;',l='select name, descriptionPlain, age, animalID, pictures, animalLocation, breed, age, sex from pets where species = ? and animalLocation = ? and breed = ? and age =? and sex =?;',q=function(){return new Promise((s,t)=>{connection.query(k,[a.session.uid,h,n,o],(u,v)=>{u?t(u):s(v)})})},p=function(s){return new Promise((t,u)=>{connection.query(l,[g,m,h,n,o],(v,w)=>{v?u(v):t({results:w,dataFromUpload:s})})})})),function(){return new Promise((s,t)=>{connection.query(j,u=>{u?t(u):s(console.log('table created'))})})}().then(()=>{return q()}).then(s=>{return f(s)}).then(s=>{return p(s)}).then(s=>{var t=[];for(let x=0;x<s.results.length;x++){var v=JSON.parse(s.results[x].pictures);console.log(v);var w=v[0].originalUrl;t.push(w)}return console.log(t),0==s.dataFromUpload.length?b.render('searchFromListings',{petsDb:s.results,photo:t}):b.render('searchFromListings2',{petsDb:s.results,uploadDb:s.dataFromUpload,photo:t})})}),router.get('/test',(a,b)=>{b.render('test')}),router.get('/profile',(a,b)=>{b.render('profile')}),router.post('/profileChange',nameOfFileField1,(a,b)=>{var d=a.body.fName,f=a.body.lName,g=a.body.email,h=a.file.path,j=`public/images/profile_images/${a.file.originalname}`;console.log(a.file);var l=function(){return new Promise(function(m,n){fs.readFile(h,(o,p)=>{if(o)throw o;fs.writeFile(j,p,q=>{if(q)throw q;var r=`UPDATE users SET profile_imgUrl = ? WHERE id = ?;`;connection.query(r,[a.file.originalname,a.session.uid],()=>{q?n(q):m('image added')})})})})};(function(){return new Promise(function(m,n){var o=`UPDATE users SET first_name = ?, last_name = ?, email = ? WHERE id = ?;`;connection.query(o,[d,f,g,a.session.uid],p=>{p?n(p):m('info updated')})})})().then(function(m){return l(m)}).then(function(){b.redirect('/profile')})}),router.get('/changePassword',(a,b)=>{b.render('changePassword')}),router.post('/changePasswordSubmit',(a,b)=>{function f(){return new Promise(m=>{j==k?m('Passwords Match'):b.redirect('/changePassword?msg=passwordNotMatch')})}function g(){return new Promise((m,n)=>{var o=bcrypt.hashSync(j),p=`update users 
set password = ? 
where email = ?;`;connection.query(p,[o,l],q=>{q?n(q):m('success')})})}var h=a.body.currentPassword,j=a.body.newPassword,k=a.body.confirmNewPassword,l=a.session.email;(function(){return new Promise((m,n)=>{connection.query('select * from users where email = ?;',[l],(p,q)=>{if(p)n(p);else{var r=bcrypt.compareSync(h,q[0].password);r?m(r):b.redirect('/changePassword?msg=wrongCurrentPass')}})})})().then(()=>{return f()}).then(()=>{return g()}).then(()=>{b.redirect('/listings')}).catch(m=>{console.log(m)})}),router.get('/emailSettings',(a,b)=>{b.render('emailSettings')}),router.get('/myListings',(a,b)=>{(function(){return new Promise(function(f,g){var h=`SELECT * FROM upload where user_id = ?`;connection.query(h,[a.session.uid],(j,k)=>{j?g(j):f(k)})})})().then(function(f){b.render('myListings',{uploadResults:f})})}),router.get('/editListings/:postid',(a,b)=>{var c=a.params.postid;console.log(c);(function(){return new Promise(function(f,g){var h=`SELECT * FROM upload where id = ?;`;connection.query(h,[c],(j,k)=>{j?g(j):f(k)})})})().then(function(f){console.log(f),b.render('editListings',{id:f[0].id,type:f[0].type,cat_breed:f[0].cat_breed,dog_breed:f[0].dog_breed,name:f[0].name_upload,age:f[0].age,gender:f[0].gender,img_url:f[0].img_url,upload_date:f[0].upload_date}),console.log(type)})}),router.get('/editListings',(a,b)=>{b.render('editListings')}),router.post('/editListings/:postid',nameOfFileField3,(a,b)=>{var d=a.params.postid,f=a.body.breed_type_select,g=a.body.dog_breed_select,h=a.body.cat_breed_select,j=a.body.pet_name,k=a.body.age,l=a.body.gender,m=a.body.description,n=a.file.path,o=`public/images/listings/${a.file.originalname}`,q=function(){return new Promise(function(r,s){fs.readFile(n,(t,u)=>{if(t)throw t;fs.writeFile(o,u,v=>{if(v)throw v;var w=`UPDATE upload SET img_url = ? WHERE id = ?`;connection.query(w,[a.file.originalname,d],()=>{console.log(a.file.path),v?s(v):r('image updated')})})})})};(function(){return new Promise(function(r,s){var t=`UPDATE upload SET type = ?, cat_breed = ?, dog_breed = ?,  name_upload = ?, age = ?, gender = ?, description = ? WHERE id = ?;`;connection.query(t,[f,h,g,j,k,l,m,d],u=>{u?s(u):r('info updated')})})})().then(function(r){return q(r)}).then(function(){b.redirect('/postUpdated')})}),router.get('/postUpdated',(a,b)=>{b.render('postUpdated')}),router.get('/favorites',(a,b)=>{function f(){return new Promise((h,j)=>{connection.query('select * from favorites as f where user_id_favorites =? inner join upload on f.pet_id = upload.id;',[a.session.uid],(l,m)=>{l?j(l):h(m)})})}a.query.id;(function(){return new Promise((h,j)=>{connection.query('select * from favorites inner join pets on favorites.pet_id = pets.animalID where user_id_favorites =?;',[a.session.uid],(l,m)=>{l?j(l):0==m.length?h(b.redirect('/listings')):h(m)})})})().then(h=>{var j=[];for(let l=0;l<h.length;l++){var k=JSON.parse(h[l].pictures);j.push(k[0].originalUrl)}return 0==h.length?f():void(console.log(j),b.render('favorites',{photo:j,data:h}))}).then(()=>{})}),router.get('/favorites/:id',(a,b)=>{var f=a.params.id;(function(){return new Promise((g,h)=>{connection.query('insert into favorites (user_id_favorites, pet_id) values(?,?);',[a.session.uid,f],k=>{k?h(k):g(f)})})})().then(g=>{console.log(g),b.redirect(`/favorites?id=${g}`)})}),router.get('/delete/:id',(a,b)=>{var f=a.params.id;(function(){return new Promise((g,h)=>{connection.query('delete from favorites where user_id_favorites =? and pet_id = ?;',[a.session.uid,f],k=>{k?h(k):g('delete success!')})})})().then(g=>{console.log(g),b.redirect('/favorites')})}),router.get('/logout',(a,b)=>{a.session.destroy(),b.redirect('/login')}),module.exports=router;